# Настройка Elasticsearch под задачи поиска фильмов

Прежде чем начинать загрузку данных в Elasticsearch, нужно определиться с созданием индексов и деталями настройки полнотекстового поиска.

## Индексы

Индекс (`index`) — это хранилище документов с одинаковой схемой данных. Каждый индекс задаётся именем и содержит полезные настройки и схему документа.

У имён индексов есть ограничения:

- только нижний регистр, заглавные буквы использовать нельзя;
- не включают символы `\, /, *, ?, ", <, >, |, #, :`, а также пробел и запятую;
- не могут начинаться с символов `-, _ , +`;
- не могут быть просто точкой `.` или двумя точками `..`;
- длина ограничена 255 байтами;
- имена, которые начинаются с точки `.`, считаются устаревшими. Они могут присутствовать только в {{скрытых индексах}}[p2f_python_hiddenindex] и в системных индексах, которые контролируются различными плагинами.

Документ (`document`) — конкретная запись в индексе, которая соответствует его схеме данных.

Схема документа (`mapping`) — {{схема данных}}[p2f_python_dataschema] в реляционных БД, которой должны соответствовать все документы. По умолчанию новые данные, которых ещё нет в схеме, будут добавляться в документ, а Elasticsearch позаботится о подборе подходящего типа. Если схему необходимо сделать строгой, то при создании индекса нужно задать настройку `"dynamic": "strict"`. Подробнее о настройке динамичности схемы можно почитать в [официальной документации на английском](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic.html){target="_blank"}.

Тип данных (`mapping datatype`) — описание способа хранения данных в заданном поле. Например, для хранения чисел используется тип `long`, а для хранения текста — `keyword`.

Итак, создадим простой индекс. Это можно сделать через Kibana, если решили её установить:

```json
PUT /table
{
	"mappings": {
		"properties": {
			"text_field": {"type": "keyword"},
			"number": {"type": "long"}
		}
	}
}
```

Индекс можно создать и через консоль. Используйте curl, чтобы не зависеть от внешних программ. Для тех, кто работает на Windows, лучше использовать Postman. Перед началом работы советуем прочитать подробную [статью об этой платформе](https://dev.to/stephencweiss/how-to-test-your-api-using-curl-postman-382c){target="_blank"} на английском. Если же вы поставили и настроили Kibana, копируйте curl-запрос в [Dev Tools](https://www.elastic.co/guide/en/kibana/current/console-kibana.html){target="_blank"}.

```bash
curl -XPUT http://127.0.0.1:9200/table -H 'Content-Type: application/json' -d '{
	"mappings": {
		"properties": {
			"text_field": {"type": "keyword"},
			"number": {"type": "long"}
		}
	}
}'
```

После этого вы увидите такой ответ:

```json
{
	"acknowledged": true,
	"shards_acknowledged": true,
	"index": "table"
}
```

Рассмотрим подробнее, что произошло. После выполнения команды `PUT /table`, вы получаете индекс с именем `table` с {{одной репликой}}[p2f_theme10_lesson1_python_onereplica] и одним [шардом](https://ru.bmstu.wiki/Шардирование_баз_данных#:~:text=Шардирование20горизонтальное20партиционирование20—20это,серверах20базы20данных2C20при20этом){target="_blank"}. То есть все данные лежат на одном сервере Elasticsearch без каких-либо копий.

Второй момент: в Elasticsearch на запросы изменения чего-либо часто приходит ответ `"acknowledged": true`. Это означает, что операция «принята к сведению», а не то, что она уже совершена. Такое поведение нужно для больших кластеров. В таком случае вам не придётся ждать ответа от всех серверов, но при этом у вас будет гарантия, что Elasticsearch обязательно исполнит данную ему операцию. Это называется eventual consistency — согласованность в конечном счёте.

Чтобы сохранить данные в Elasticsearch, воспользуйтесь простой командой:

```bash
curl -XPOST http://127.0.0.1:9200/table/_doc/ -H 'Content-Type: application/json' -d'
{
	"text_field": "my pretty text",
	"number": 15
}'
```

После выполнения запроса могут возникнуть такие ситуации:

1. Если в Elasticsearch не было индекса с именем `table`, то он создастся автоматически с {{наиболее подходящими типами данных}}[p2f_theme10_lesson1_python_bestdatatype] для полей. Так делать не рекомендуется, потому что в итоге вы получите неконтролируемую схему данных.
2. Если индекс с таким названием уже существует, а все поля во входящем запросе подходят схеме данных по типам, вы получите новую запись с автоматически сгенерированным {{id}}[p2f_theme10_lesson1_python_id] и с версией записи 1. Выглядит это так:

```json
{
	"_index": "table",
	"_type": "_doc",
	"_id": "nZElhnIB-W6dcc_UKo2E",
	"_version": 1,
	"result": "created",
	"_shards": {
		"total": 2,
		"successful": 1,
		"failed":0
	},
	"_seq_no": 0,
	"_primary_term": 1
}
```

В приведённом примере стоит рассмотреть подробнее, что нам вернул Elasticsearch:

- `_index` — название индекса, куда произвели запись.
- `_type` — {{название схемы данных}}[p2f_theme10_lesson1_python_schemaname].
- `_id` — присвоенный или автоматически сгенерированный id документа, который задаёт уникальность записи.
- `_version` — версия документа, которая меняется при изменении данных.
- `result` — результат выполнения операции.
- `_shards` — секция, которая показывает, во сколько шардов попала текущая запись, сколько ответили ошибкой и общее количество шардов.
- `_seq_no` *—* параметр, который необходим для [оптимистической блокировки](https://en.wikipedia.org/wiki/Optimistic_concurrency_control){target="_blank"}. Подробнее о нём можно прочитать в [официальной документации](https://www.elastic.co/guide/en/elasticsearch/reference/master/optimistic-concurrency-control.html){target="_blank"} на английском.
- `_primary_term` — также относится к механизму оптимистической блокировки.

Если вам нужно обновить уже существующую запись, достаточно добавить в запрос id записи:

```bash
curl -XPOST http://127.0.0.1:9200/table/_doc/nZElhnIB-W6dcc_UKo2E -H 'Content-Type: application/json' -d'
{
	"text_field": "my pretty text",
	"number": 16
}'
```

Данные изменились, а поля `_version`, `_seq_no` и `result` поменяли свои значения относительно запроса на сохранение. Это помогает строить подходящую стратегию для записи данных, чтобы они не дублировались.

Подробнее про вставку данных в индекс можно прочитать в [официальной документации](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html){target="_blank"} на английском.